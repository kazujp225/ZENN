import { createClient } from '@supabase/supabase-js'
import * as dotenv from 'dotenv'
import * as path from 'path'

// Load environment variables
dotenv.config({ path: path.resolve(process.cwd(), '.env.local') })

async function testDirect() {
  try {
    // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
    const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY!
    
    // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
    console.log('ðŸ”‘ Service Role Key:', serviceRoleKey ? `${serviceRoleKey.slice(0, 20)}...` : 'Missing')
    
    // Create client with service role key (bypasses RLS)
    const supabase = createClient(supabaseUrl, serviceRoleKey, {
      auth: {
        autoRefreshToken: false,
        persistSession: false
      }
    })
    
    // Test 1: Simple health check
    // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
    const { data: healthData, error: healthError } = await supabase
      .from('users')
      .select('count', { count: 'exact', head: true })
    
    if (healthError) {
      // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
      // Try to create a simple table to test connection
      // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
      const { error: createError } = await supabase
        .from('test_table')
        .select('*')
        .limit(1)
        
      // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
      return false
    }
    
    // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
    // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
    // Test 2: Try to insert a test user
    // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
    const testUser = {
      username: 'test_user_' + Date.now(),
      email: `test_${Date.now()}@example.com`,
      display_name: 'Test User'
    }
    
    const { data: insertData, error: insertError } = await supabase
      .from('users')
      .insert(testUser)
      .select()
      .single()
    
    if (insertError) {
      // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
    } else {
      // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
      // Clean up - delete the test user
      await supabase
        .from('users')
        .delete()
        .eq('id', insertData.id)
      
      // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
    }
    
    // Test 3: Check other tables
    // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
    const tables = ['articles', 'books', 'scraps', 'topics']
    
    for (const table of tables) {
      const { count, error } = await supabase
        .from(table)
        .select('*', { count: 'exact', head: true })
      
      if (error) {
        // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
      } else {
        // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
      }
    }
    
    // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
    return true
    
  } catch (error: any) {
    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
    return false
  }
}

testDirect().then(success => {
  console.log('\n' + '='.repeat(50))
  // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
  console.log('='.repeat(50))
  
  if (success) {
    // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
    // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
    // console.logå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
  }
  
  process.exit(success ? 0 : 1)
})